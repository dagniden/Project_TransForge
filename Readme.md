

# Описание данных

Оригинальный файл с операциями: [Ссылка на файл](https://docs.google.com/spreadsheets/d/1yXnr282zAMcTkEhIwZFaJlPJvAeZIwvB/edit?gid=1794603603#gid=1794603603)


| Поле                           | Описание |
|--------------------------------|----------|
| **Дата операции**              | Дата, когда произошла транзакция |
| **Дата платежа**               | Дата, когда был произведен платеж |
| **Номер карты**                | Последние 4 цифры номера карты |
| **Статус**                     | Статус операции (например, `OK`, `FAILED`) |
| **Сумма операции**             | Сумма транзакции в оригинальной валюте |
| **Валюта операции**            | Валюта, в которой была произведена транзакция |
| **Сумма платежа**              | Сумма транзакции в валюте счета |
| **Валюта платежа**             | Валюта счета |
| **Кешбэк**                     | Размер полученного кешбэка |
| **Категория**                  | Категория транзакции |
| **MCC**                        | Код категории транзакции (соответствует международной классификации) |
| **Описание**                   | Описание транзакции |
| **Бонусы (включая кешбэк)**    | Количество полученных бонусов (включая кешбэк) |
| **Округление на «Инвесткопилку»** | Сумма, которая была округлена и переведена на «Инвесткопилку» |
| **Сумма операции с округлением** | Сумма транзакции, округленная до ближайшего целого числа |






# Сервисы:
- Выгодные категории повышенного кешбэка
- Инвесткопилка
- Простой поиск
- Поиск по телефонным номерам
- Поиск переводов физическим лицам


## Пример данных
```
Я МТС +7 921 11-22-33
Тинькофф Мобайл +7 995 555-55-55
МТС Mobile +7 981 333-44-55
```

# Структура проекта
```
.
├── src
│ ├── __init__.py
│ ├── utils.py
│ ├── main.py
│ ├── views.py
│ ├── reports.py
│ └── services.py
├── data
│ ├── operations.xlsx
├── tests
│ ├── __init__.py
│ ├── test_utils.py
│ ├── test_views.py
│ ├── test_reports.py
│ └── test_services.py
├── user_settings.json
├── .venv/
├── .env
├── .env_template
├── .git/
├── .idea/
├── .flake8
├── .gitignore
├── pyproject.toml
├── poetry.lock
└── README.md
```

# Модуль utils.py
Модуль utils.py содержит набор вспомогательных функций для работы с файлами и данными о биржевых акциях.
Он включает загрузку и чтение данных из Excel и JSON, получение котировок акций через внешний API, а также фильтрацию последних цен акций.
В модуле настроен логгер (loguru) для записи отладочных и ошибочных сообщений в файл logs/utils.log.

## Основные функции
- read_excel(filename: str) -> list[dict] - Загружает данные из Excel-файла и возвращает список словарей.
- read_json(filename: str) -> dict | list[dict] - Читает JSON-файл и возвращает словарь или список словарей.
- get_stock_prices(stock_names: list) -> list - Получает котировки акций по их тикерам с помощью API Marketstack.
- filter_last_stocks(data: list[dict], stock_names: list) -> list - Фильтрует список последних цен акций в долларах США.

## Примеры использования:
```python
from utils import read_excel, read_json, get_stock_prices, filter_last_stocks

# Чтение Excel-файла
transactions = read_excel("transactions.xlsx")
print(transactions[:5])  # первые 5 записей

# Чтение JSON-файла настроек
settings = read_json("user_settings.json")
print(settings)

# Получение котировок по списку акций
stock_names = ["AAPL", "TSLA", "MSFT"]
data = get_stock_prices(stock_names)

# Фильтрация последних цен акций
last_prices = filter_last_stocks(data, stock_names)
print(last_prices)

```

# Модуль services.py

Модуль **services.py** содержит функции для анализа и поиска финансовых транзакций.
Он включает инструменты для агрегации данных по категориям кэшбэка, поиска транзакций по шаблону (регулярным выражениям), а также специальные функции для поиска переводов физическим лицам и платежей по мобильным номерам.

## Основные функции

* **analyze\_cashback(data: list\[dict], year: int, month: int) -> str**
  Анализирует транзакции и возвращает JSON с суммами кэшбэка по категориям за указанный месяц и год.

* **search\_transactions(data: list\[dict], search: str, scope: tuple = ("Описание", "Категория")) -> str**
  Выполняет поиск транзакций по регулярному выражению в заданных полях (по умолчанию — *Описание* и *Категория*) и возвращает JSON со всеми найденными записями.

* **search\_transactions\_p2p(data: list\[dict]) -> str**
  Возвращает JSON со всеми транзакциями, которые относятся к переводам физическим лицам (поиск по ФИО в формате «Фамилия И.»).

* **search\_transactions\_by\_phone(data: list\[dict]) -> str**
  Возвращает JSON со всеми транзакциями, в описании которых содержатся мобильные номера в формате «+7 999 123-45-67».

## Примеры использования

```python
from services import analyze_cashback, search_transactions, search_transactions_p2p, search_transactions_by_phone

# Анализ кэшбэка за март 2024 года
result = analyze_cashback(transactions, 2024, 3)
print(result)

# Поиск транзакций, связанных с "Супермаркетами"
result = search_transactions(transactions, r"Супермаркеты")
print(result)

# Поиск переводов физическим лицам
p2p = search_transactions_p2p(transactions)
print(p2p)

# Поиск транзакций с номерами телефонов
phones = search_transactions_by_phone(transactions)
print(phones)
```


